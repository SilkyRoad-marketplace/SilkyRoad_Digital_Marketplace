<!doctype html>
<html lang="en">
<head>
<link rel="stylesheet" href="styles.css">  
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" href="/favicon.png">
<title>Browse Category – Silky Road</title>

<meta name="description" content="Browse digital products by category on Silky Road Marketplace.">
<meta name="keywords" content="digital products, category, ebooks, downloads, silky road">

<style>
body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:0;background:#f7f7f9;color:#222}
.header{background:#fff;border-bottom:1px solid #e4e4e8}
.container{max-width:1100px;margin:0 auto;padding:16px}
nav{display:flex;align-items:center;justify-content:space-between}
nav .links a{margin-left:12px;text-decoration:none;color:#333;font-weight:600}
nav .links button{background:#2b6ef6;color:#fff;border:none;padding:10px 14px;border-radius:6px;cursor:pointer}

.banner{position:relative}
.banner img{width:100%;height:auto;display:block}
.banner-text{display:none !important;}

.card{
  background:#fff;
  padding:12px;
  border:1px solid #e6e6ea;
  box-sizing:border-box;
  margin-bottom:12px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,0.05);
}

/* Product grid */
.product-grid{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
}
.card.product-card{
  width:calc(25% - 9px);
}
.card.product-card img{
  width:100%;
  height:auto;
  border-radius:6px;
}
.card.product-card h4{
  margin:8px 0 4px;
  font-size:16px;
}
.card.product-card p{
  margin:2px 0;
}

/* MOBILE */
@media(max-width:600px){
  .card.product-card{width:calc(50% - 6px);}
}

/* Logo styling */
.logo-img {
  height: 39px;
  width: auto;
  vertical-align: middle;
}

.footer{background:#222;color:#fff;padding:12px;margin-top:20px;text-align:center}
button{background:#2b6ef6;color:#fff;border:none;padding:10px 14px;border-radius:6px;cursor:pointer}
.text-muted{color:#777;font-size:13px}
</style>
</head>

<body>

<!-- Shared Header -->
<style>.logo-img{height:39px;width:auto;vertical-align:middle}</style>
<div id="header"></div>
<script>
  fetch("header.html?v=1")
    .then(r => r.text())
    .then(d => document.getElementById("header").innerHTML = d)
    .catch(e => console.error("Header load failed:", e));
</script>

<!-- Banner -->
<div class="banner">
  <img src="banner.jpg" alt="Silky Road Banner">
  <div class="banner-text">
    <h1>Discover & Download Digital Products Instantly</h1>
    <p>Ebooks, art, music, software, and more — delivered automatically with no shipping required.</p>
  </div>
</div>

<main class="container" style="margin-top:16px;">

  <div class="card">
    <h2 id="categoryTitle">Category</h2>
    <p id="categoryInfo" class="text-muted"></p>
  </div>

  <!-- Sub-category highlighted section -->
  <div id="subSection" class="card" style="display:none;">
    <h3 id="subTitle"></h3>
    <div id="subProducts" class="product-grid"></div>
    <p id="subEmpty" class="text-muted"></p>
  </div>

  <!-- Other items in this category -->
  <div id="otherSection" class="card" style="display:none;">
    <h3 id="otherTitle"></h3>
    <div id="otherProducts" class="product-grid"></div>
    <p id="otherEmpty" class="text-muted"></p>
  </div>

</main>

<footer class="footer"></footer>

<script type="module">
  import { supabase } from "./js/supabase-config.js";

  const params = new URLSearchParams(window.location.search);
  const category = params.get("category");
  const sub = params.get("sub");

  const categoryTitle = document.getElementById("categoryTitle");
  const categoryInfo = document.getElementById("categoryInfo");
  const subSection = document.getElementById("subSection");
  const subTitle = document.getElementById("subTitle");
  const subProducts = document.getElementById("subProducts");
  const subEmpty = document.getElementById("subEmpty");

  const otherSection = document.getElementById("otherSection");
  const otherTitle = document.getElementById("otherTitle");
  const otherProducts = document.getElementById("otherProducts");
  const otherEmpty = document.getElementById("otherEmpty");

  async function loadCategory() {
    if (!category) {
      categoryTitle.textContent = "All Products";
      categoryInfo.textContent = "No category specified.";
      return;
    }

    categoryTitle.textContent = category;
    categoryInfo.textContent = sub
      ? "Showing sub-category: " + sub
      : "Showing all items in this category.";

    // Load all products for this category
    const { data, error } = await supabase
      .from("products")
      .select("*")
      .eq("category", category)
      .order("created_at", { ascending: false });

    if (error) {
      categoryInfo.textContent = "Error loading products.";
      console.error(error);
      return;
    }

    if (!data || data.length === 0) {
      categoryInfo.textContent = "No products found in this category yet.";
      return;
    }

    // Option C logic:
    // - if sub exists: highlight those first
    // - then show other items in same category below
    if (sub) {
      const primary = data.filter(p => (p.subcategory || "") === sub);
      const others = data.filter(p => (p.subcategory || "") !== sub);

      // Sub-section
      subSection.style.display = "block";
      subTitle.textContent = "Sub-category: " + sub;
      renderProducts(primary, subProducts, subEmpty, "No products yet in this sub-category.");

      // Other items
      otherSection.style.display = "block";
      otherTitle.textContent = "Other items in " + category;
      renderProducts(others, otherProducts, otherEmpty, "No other items in this category yet.");
    } else {
      // No sub-category given: just show all in one list
      subSection.style.display = "block";
      subTitle.textContent = "All items in " + category;
      renderProducts(data, subProducts, subEmpty, "No products yet in this category.");
    }
  }

  function renderProducts(items, container, emptyLabel, emptyText) {
    container.innerHTML = "";
    if (!items || items.length === 0) {
      emptyLabel.textContent = emptyText;
      return;
    }
    emptyLabel.textContent = "";
    items.forEach(p => {
      const card = document.createElement("div");
      card.className = "card product-card";

      const img = document.createElement("img");
      img.src = p.thumbnail_url || "placeholder.jpg";
      img.alt = p.title || "Product";
      img.style.cursor = "pointer";
      img.addEventListener("click", () => {
        window.location.href = "product.html?id=" + p.id;
      });

      const title = document.createElement("h4");
      const link = document.createElement("a");
      link.textContent = p.title || "Untitled";
      link.href = "product.html?id=" + p.id;
      link.style.textDecoration = "none";
      link.style.color = "#222";
      title.appendChild(link);

      const price = document.createElement("p");
      price.innerHTML = "<strong>USD " + (p.price || 0).toFixed(2) + "</strong>";

      card.appendChild(img);
      card.appendChild(title);
      card.appendChild(price);
      container.appendChild(card);
    });
  }

  loadCategory();
</script>

</body>
</html>
