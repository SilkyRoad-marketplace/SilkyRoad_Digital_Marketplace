<!doctype html>
<html lang="en">
<head>
<link rel="stylesheet" href="styles.css">  
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" href="/favicon.png">
<title>Download – Silky Road</title>

<meta name="description" content="Secure download page for your purchased digital product.">
<meta name="keywords" content="download, digital products, silky road">

<style>
body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:0;background:#f7f7f9;color:#222}
.header{background:#fff;border-bottom:1px solid #e4e4e8}
.container{max-width:600px;margin:0 auto;padding:16px}
.banner{position:relative}
.banner img{width:100%;height:auto;display:block}
.banner-text{display:none !important;}
.card{
  background:#fff;
  padding:16px;
  border:1px solid #e6e6ea;
  box-sizing:border-box;
  margin:24px 0;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,0.05);
  text-align:center;
}
.footer{background:#222;color:#fff;padding:12px;margin-top:20px;text-align:center}
button{
  background:#2b6ef6;color:#fff;border:none;
  padding:10px 18px;border-radius:6px;
  cursor:pointer;font-size:16px;
}
.text-muted{color:#777;font-size:13px}

/* Logo styling */
.logo-img {
  height: 39px;
  width: auto;
  vertical-align: middle;
}
</style>
</head>

<body>

<!-- Shared Header -->
<style>.logo-img{height:39px;width:auto;vertical-align:middle}</style>
<div id="header"></div>
<script>
  fetch("header.html?v=1")
    .then(r => r.text())
    .then(d => document.getElementById("header").innerHTML = d)
    .catch(e => console.error("Header load failed:", e));
</script>

<!-- Banner -->
<div class="banner">
  <img src="banner.jpg" alt="Silky Road Banner">
  <div class="banner-text">
    <h1>Discover & Download Digital Products Instantly</h1>
    <p>Ebooks, art, music, software, and more — delivered automatically with no shipping required.</p>
  </div>
</div>

<main class="container">

  <div id="downloadCard" class="card">
    <h2>Preparing your download…</h2>
    <p class="text-muted" id="downloadMessage">Checking your secure link.</p>
  </div>

</main>

<!-- FOOTER -->
<footer class="footer"></footer>
<script>
  fetch("footer.html?v=2")
    .then(r => r.text())
    .then(d => document.querySelector(".footer").innerHTML = d)
    .catch(e => console.error("Footer load failed:", e));
</script>
<script type="module">
  import { supabase } from "./js/supabase-config.js";

  const params = new URLSearchParams(window.location.search);
  const token = params.get("token");
  const card = document.getElementById("downloadCard");
  const messageEl = document.getElementById("downloadMessage");

  async function init() {
    if (!token) {
      card.innerHTML = "<h2>Invalid link</h2><p class='text-muted'>No download token was provided.</p>";
      return;
    }

    const { data, error } = await supabase
      .from("download_links")
      .select("*")
      .eq("token", token)
      .maybeSingle();

    if (error || !data) {
      card.innerHTML = "<h2>Link not found</h2><p class='text-muted'>This download link is invalid or has been removed.</p>";
      return;
    }

    const now = new Date();
    const expiresAt = new Date(data.expires_at);

    if (now > expiresAt) {
      card.innerHTML = "<h2>Download link expired</h2><p class='text-muted'>This download link has expired. The link is only valid for 3 days after purchase.</p>";
      return;
    }

    // Valid link
    card.innerHTML = `
      <h2>Your download is ready</h2>
      <p class="text-muted">Thank you for your purchase. Click the button below to download your file.</p>
      <button id="downloadBtn">Download Now</button>
      <p class="text-muted" style="margin-top:10px;">This link will stop working after the expiry time set at purchase.</p>
    `;

    const downloadBtn = document.getElementById("downloadBtn");
    downloadBtn.addEventListener("click", () => {
      window.location.href = data.file_url;
    });
  }

  init();
</script>

</body>
</html>
