<!doctype html>
<html lang="en">
<head>
<link rel="stylesheet" href="styles.css">  
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" href="/favicon.png">
<title>Silky Road – Seller Dashboard</title>

<meta name="description" content="Seller Dashboard for Silky Road – upload digital products, manage listings, and view sales.">
<meta name="keywords" content="seller dashboard, digital marketplace, sell digital products, silky road">

<style>
body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:0;background:#f7f7f9;color:#222}
.header{background:#fff;border-bottom:1px solid #e4e4e8}
.container{max-width:1100px;margin:0 auto;padding:16px}
nav{display:flex;align-items:center;justify-content:space-between}
nav .links a{margin-left:12px;text-decoration:none;color:#333;font-weight:600}
nav .links button{background:#2b6ef6;color:#fff;border:none;padding:10px 14px;border-radius:6px;cursor:pointer}

.banner{position:relative}
.banner img{width:100%;height:auto;display:block}
.banner-text{display:none !important;}

.category-bar{
  margin:20px 0;
  background:#ffffff;
  padding:12px;
  border:1px solid #e6e6ea;
  display:flex;
  gap:20px;
  font-weight:bold;
  flex-wrap:wrap;
}
.category-bar > div{position:relative; cursor:pointer;}
.category-bar div ul{
  display:none;
  position:absolute;
  background:#fff;
  list-style:none;
  padding:10px;
  margin:0;
  border:1px solid #ccc;
  width:220px;
  z-index:999;
}
.category-bar div:hover ul{display:block;}
.category-bar ul li{padding:6px 0;}
.category-bar a{text-decoration:none;color:#333;font-weight:normal;}

.row{display:flex;gap:16px;margin-top:16px}
.main{flex:1}

.product-grid{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
}
.card{
  background:#fff;
  padding:12px;
  border:1px solid #e6e6ea;
  box-sizing:border-box;
  margin-bottom:12px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,0.05);
}

/* Logo styling */
.logo-img {
  height: 39px; /* Adjust the logo size */
  width: auto;
  vertical-align: middle;
}

/* MOBILE */
@media(max-width:600px){
  .card{width:100%;}
}

.footer{background:#222;color:#fff;padding:12px;margin-top:20px;text-align:center}
button{background:#2b6ef6;color:#fff;border:none;padding:10px 14px;border-radius:6px;cursor:pointer}

/* DASHBOARD-SPECIFIC STYLES */
.flex{display:flex;gap:16px;flex-wrap:wrap}
.products-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
.product-card img{width:100%;border-radius:6px}
label{display:block;margin-top:8px;font-weight:bold}
input[type="text"],input[type="email"],input[type="password"],input[type="number"],textarea{
  width:100%;padding:8px;margin-top:4px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box
}
.btn-primary{background:#2b6ef6;color:#fff}
.btn-secondary{background:#6c757d;color:#fff}
.btn-danger{background:#dc3545;color:#fff}
.hidden{display:none}
.text-muted{color:#777;font-size:13px}
</style>
</head>

<body>

<!-- Shared Header -->
<div id="header"></div>
<script>
  fetch("header.html?v=1")
    .then(r => r.text())
    .then(d => document.getElementById("header").innerHTML = d)
    .catch(e => console.error("Header load failed:", e));
</script>

<main class="container" style="margin-top:16px;">

  <!-- Auth Section -->
  <div id="authSection" class="card">
    <h3>Seller Sign Up / Login</h3>
    <p class="text-muted">Use email/password or Google to access your seller dashboard.</p>

    <div class="flex">
      <!-- Email Sign Up / Login -->
      <div style="flex:1; min-width:260px;">
        <h4>Email Sign Up</h4>
        <label>First Name</label>
        <input type="text" id="signupFirstName">

        <label>Last Name</label>
        <input type="text" id="signupLastName">

        <label>Email</label>
        <input type="email" id="signupEmail">

        <label>Password</label>
        <input type="password" id="signupPassword">

        <button id="signupBtn" class="btn-primary" style="margin-top:8px;">Sign Up</button>

        <p class="text-muted" style="margin-top:8px;">After sign up, check your email and confirm to activate your account.</p>

        <hr style="margin:16px 0;">

        <h4>Email Login</h4>
        <label>Email</label>
        <input type="email" id="loginEmail">

        <label>Password</label>
        <input type="password" id="loginPassword">

        <button id="loginBtn" class="btn-secondary" style="margin-top:8px;">Login</button>
      </div>

      <!-- Google Sign In -->
      <div style="flex:1; min-width:260px;">
        <h4>Or Sign In with Google</h4>
        <p class="text-muted">Recommended for fast access.</p>
        <button id="googleLoginBtn" class="btn-primary">Continue with Google</button>
      </div>
    </div>

    <p id="authMessage" class="text-muted" style="margin-top:12px;"></p>
  </div>

  <!-- Dashboard Section (hidden until logged in) -->
  <div id="dashboardSection" class="hidden">

    <!-- Top bar: profile + logout -->
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <h2>Seller Dashboard</h2>
      <button id="logoutBtn" class="btn-secondary hidden">Logout</button>
    </div>

    <!-- Profile Card -->
    <div class="card">
      <h3>Your Seller Profile</h3>
      <p id="welcomeText"></p>

      <label>First Name</label>
      <input type="text" id="profileFirstName">

      <label>Last Name</label>
      <input type="text" id="profileLastName">

      <label>Your Login Email (read-only)</label>
      <input type="email" id="profileEmail" disabled>

      <label>Your PayPal Email (for receiving payouts)</label>
      <input type="email" id="profilePaypalEmail">

      <button id="saveProfileBtn" class="btn-primary" style="margin-top:8px;">Save Profile</button>
      <p class="text-muted" id="profileMessage" style="margin-top:8px;"></p>
    </div>

    <!-- Upload Product Card -->
    <div class="card">
      <h3>Upload New Product</h3>

      <label>Thumbnail (JPG only)</label>
      <input type="file" id="thumbnailInput" accept="image/jpeg">

      <label>Title</label>
      <input type="text" id="productTitle">

      <label>Description</label>
      <textarea id="productDescription" rows="4"></textarea>

      <label>Price (USD)</label>
      <input type="number" id="productPrice" min="0" step="0.01">

      <label>Product File (max 10 MB)</label>
      <input type="file" id="fileInput">

      <label>External Download Link (optional)</label>
      <input type="text" id="externalLink">

      <p class="text-muted">
        If your file is more than 10MB, you can paste your external download link here (if you have).
        We will deliver your download link and secure it safely.
      </p>

      <button id="uploadProductBtn" class="btn-primary" style="margin-top:8px;">Save Product</button>
      <p id="uploadMessage" class="text-muted" style="margin-top:8px;"></p>
    </div>

    <!-- Seller Products + Sales -->
    <div class="flex">
      <!-- My Products -->
      <div class="card" style="flex:2; min-width:320px;">
        <h3>Your Products</h3>
        <div id="productsList" class="products-grid"></div>
        <p id="noProductsMessage" class="text-muted"></p>
      </div>

      <!-- Simple Sales Report -->
      <div class="card" style="flex:1; min-width:260px;">
        <h3>Sales Summary</h3>
        <p>Total Orders: <strong id="totalOrders">0</strong></p>
        <p>Total Revenue (USD): <strong id="totalRevenue">0.00</strong></p>
        <h4 style="margin-top:12px;">Recent Orders</h4>
        <ul id="recentOrdersList" class="text-muted" style="padding-left:18px;"></ul>
      </div>
    </div>
  </div>

</main>

<footer class="footer"></footer>

<script type="module">
  import { supabase } from "./js/supabase-config.js";

  const authSection = document.getElementById("authSection");
  const dashboardSection = document.getElementById("dashboardSection");
  const logoutBtn = document.getElementById("logoutBtn");
  const authMessage = document.getElementById("authMessage");

  const signupFirstName = document.getElementById("signupFirstName");
  const signupLastName = document.getElementById("signupLastName");
  const signupEmail = document.getElementById("signupEmail");
  const signupPassword = document.getElementById("signupPassword");
  const signupBtn = document.getElementById("signupBtn");

  const loginEmail = document.getElementById("loginEmail");
  const loginPassword = document.getElementById("loginPassword");
  const loginBtn = document.getElementById("loginBtn");
  const googleLoginBtn = document.getElementById("googleLoginBtn");

  const welcomeText = document.getElementById("welcomeText");
  const profileFirstName = document.getElementById("profileFirstName");
  const profileLastName = document.getElementById("profileLastName");
  const profileEmail = document.getElementById("profileEmail");
  const profilePaypalEmail = document.getElementById("profilePaypalEmail");
  const saveProfileBtn = document.getElementById("saveProfileBtn");
  const profileMessage = document.getElementById("profileMessage");

  const thumbnailInput = document.getElementById("thumbnailInput");
  const productTitle = document.getElementById("productTitle");
  const productDescription = document.getElementById("productDescription");
  const productPrice = document.getElementById("productPrice");
  const fileInput = document.getElementById("fileInput");
  const externalLinkInput = document.getElementById("externalLink");
  const uploadProductBtn = document.getElementById("uploadProductBtn");
  const uploadMessage = document.getElementById("uploadMessage");

  const productsList = document.getElementById("productsList");
  const noProductsMessage = document.getElementById("noProductsMessage");
  const totalOrdersEl = document.getElementById("totalOrders");
  const totalRevenueEl = document.getElementById("totalRevenue");
  const recentOrdersList = document.getElementById("recentOrdersList");

  let currentUser = null;
  const BUCKET_NAME = "seller-uploads"; // as you chose

  // --- AUTH LOGIC ---

  async function checkSession() {
    const { data, error } = await supabase.auth.getUser();
    if (error || !data.user) {
      authSection.classList.remove("hidden");
      dashboardSection.classList.add("hidden");
      logoutBtn.classList.add("hidden");
      return;
    }
    currentUser = data.user;
    authSection.classList.add("hidden");
    dashboardSection.classList.remove("hidden");
    logoutBtn.classList.remove("hidden");
    loadProfile();
    loadProducts();
    loadSalesSummary();
  }

  signupBtn.addEventListener("click", async () => {
    authMessage.textContent = "";
    if (!signupEmail.value || !signupPassword.value) {
      authMessage.textContent = "Please enter email and password.";
      return;
    }

    const { data, error } = await supabase.auth.signUp({
      email: signupEmail.value,
      password: signupPassword.value,
      options: {
        data: {
          first_name: signupFirstName.value,
          last_name: signupLastName.value
        },
        emailRedirectTo: window.location.origin + "/dashboard.html"
      }
    });

    if (error) {
      authMessage.textContent = "Sign up error: " + error.message;
    } else {
      authMessage.textContent = "Sign up successful. Please check your email to confirm.";
    }
  });

  loginBtn.addEventListener("click", async () => {
    authMessage.textContent = "";
    const { error } = await supabase.auth.signInWithPassword({
      email: loginEmail.value,
      password: loginPassword.value
    });
    if (error) {
      authMessage.textContent = "Login error: " + error.message;
    } else {
      authMessage.textContent = "Logged in. Loading dashboard...";
      checkSession();
    }
  });

  googleLoginBtn.addEventListener("click", async () => {
    const { data, error } = await supabase.auth.signInWithOAuth({
      provider: "google",
      options: {
        redirectTo: window.location.origin + "/dashboard.html"
      }
    });
    if (error) {
      authMessage.textContent = "Google login error: " + error.message;
    }
  });

  logoutBtn.addEventListener("click", async () => {
    await supabase.auth.signOut();
    currentUser = null;
    authSection.classList.remove("hidden");
    dashboardSection.classList.add("hidden");
    logoutBtn.classList.add("hidden");
  });

  // --- PROFILE ---

  async function loadProfile() {
    if (!currentUser) return;

    profileEmail.value = currentUser.email || "";

    const { data, error } = await supabase
      .from("profiles")
      .select("*")
      .eq("id", currentUser.id)
      .maybeSingle();

    if (error) {
      console.log("loadProfile error", error);
      return;
    }

    if (data) {
      profileFirstName.value = data.first_name || "";
      profileLastName.value = data.last_name || "";
      profilePaypalEmail.value = data.paypal_email || "";
      welcomeText.textContent = `Welcome, ${data.first_name || ""} ${data.last_name || ""}`.trim();
    } else {
      welcomeText.textContent = "Welcome! Please complete your profile.";
    }
  }

  saveProfileBtn.addEventListener("click", async () => {
    if (!currentUser) return;
    profileMessage.textContent = "";

    const updates = {
      id: currentUser.id,
      first_name: profileFirstName.value,
      last_name: profileLastName.value,
      paypal_email: profilePaypalEmail.value
    };

    const { error } = await supabase
      .from("profiles")
      .upsert(updates, { onConflict: "id" });

    if (error) {
      profileMessage.textContent = "Error saving profile: " + error.message;
    } else {
      profileMessage.textContent = "Profile saved.";
      welcomeText.textContent = `Welcome, ${profileFirstName.value} ${profileLastName.value}`.trim();
    }
  });

  // --- PRODUCT UPLOAD ---

  uploadProductBtn.addEventListener("click", async () => {
    if (!currentUser) {
      uploadMessage.textContent = "Please log in first.";
      return;
    }

    uploadMessage.textContent = "";

    if (!profilePaypalEmail.value) {
      uploadMessage.textContent = "Please set your PayPal email before uploading products.";
      return;
    }

    if (!productTitle.value || !productPrice.value) {
      uploadMessage.textContent = "Please enter title and price.";
      return;
    }

    const priceCents = Math.round(parseFloat(productPrice.value) * 100);

    if (isNaN(priceCents) || priceCents < 0) {
      uploadMessage.textContent = "Invalid price.";
      return;
    }

    const thumbnailFile = thumbnailInput.files[0];
    const productFile = fileInput.files[0];
    const externalLink = externalLinkInput.value.trim();

    if (!thumbnailFile) {
      uploadMessage.textContent = "Please select a thumbnail (JPG).";
      return;
    }

    if (thumbnailFile.type !== "image/jpeg") {
      uploadMessage.textContent = "Thumbnail must be a JPG file.";
      return;
    }

    // Check file size (if file is provided)
    if (productFile && productFile.size > 10 * 1024 * 1024) {
      uploadMessage.textContent = "File too large. Maximum allowed is 10 MB.";
      return;
    }

    if (!productFile && !externalLink) {
      uploadMessage.textContent = "Please upload a file or provide an external download link.";
      return;
    }

    uploadMessage.textContent = "Uploading... please wait.";

    try {
      // Upload thumbnail
      const thumbPath = `${currentUser.id}/thumbnails/${Date.now()}-${thumbnailFile.name}`;
      const { error: thumbErr } = await supabase
        .storage
        .from(BUCKET_NAME)
        .upload(thumbPath, thumbnailFile);

      if (thumbErr) throw thumbErr;

      const { data: thumbUrlData } = supabase
        .storage
        .from(BUCKET_NAME)
        .getPublicUrl(thumbPath);

      let filePath = null;
      let filePublicUrl = null;

      if (productFile) {
        filePath = `${currentUser.id}/files/${Date.now()}-${productFile.name}`;
        const { error: fileErr } = await supabase
          .storage
          .from(BUCKET_NAME)
          .upload(filePath, productFile);

        if (fileErr) throw fileErr;

        const { data: fileUrlData } = supabase
          .storage
          .from(BUCKET_NAME)
          .getPublicUrl(filePath);

        filePublicUrl = fileUrlData.publicUrl;
      }

      // Save product in DB
      const { error: insertErr } = await supabase
        .from("products")
        .insert({
          seller_id: currentUser.id,
          title: productTitle.value,
          description: productDescription.value,
          price_cents: priceCents,
          thumbnail_url: thumbUrlData.publicUrl,
          thumbnail_path: thumbPath,
          file_url: filePublicUrl,
          file_path: filePath,
          external_url: externalLink || null,
          is_featured: true  // new uploads become featured
        });

      if (insertErr) throw insertErr;

      uploadMessage.textContent = "Product saved successfully.";
      thumbnailInput.value = "";
      productTitle.value = "";
      productDescription.value = "";
      productPrice.value = "";
      fileInput.value = "";
      externalLinkInput.value = "";

      loadProducts();
    } catch (err) {
      console.error(err);
      uploadMessage.textContent = "Error uploading product: " + err.message;
    }
  });

  // --- LOAD SELLER PRODUCTS ---

  async function loadProducts() {
    if (!currentUser) return;

    productsList.innerHTML = "";
    noProductsMessage.textContent = "Loading...";

    const { data, error } = await supabase
      .from("products")
      .select("*")
      .eq("seller_id", currentUser.id)
      .order("created_at", { ascending: false });

    if (error) {
      noProductsMessage.textContent = "Error loading products.";
      console.log(error);
      return;
    }

    if (!data || data.length === 0) {
      noProductsMessage.textContent = "You have not uploaded any products yet.";
      return;
    }

    noProductsMessage.textContent = "";
    data.forEach(product => {
      const card = document.createElement("div");
      card.className = "product-card card";

      const thumb = document.createElement("img");
      thumb.src = product.thumbnail_url || "";
      thumb.alt = product.title || "Product thumbnail";

      // Click thumbnail → product page
      thumb.style.cursor = "pointer";
      thumb.addEventListener("click", () => {
        window.location.href = `product.html?id=${product.id}`;
      });

      const titleLink = document.createElement("a");
      titleLink.textContent = product.title;
      titleLink.href = `product.html?id=${product.id}`;
      titleLink.style.display = "block";
      titleLink.style.fontWeight = "bold";
      titleLink.style.marginTop = "6px";

      const price = document.createElement("div");
      price.textContent = "USD " + (product.price_cents / 100).toFixed(2);

      const desc = document.createElement("div");
      desc.textContent = (product.description || "").slice(0, 80) + "...";

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "Delete";
      deleteBtn.className = "btn-danger";
      deleteBtn.style.marginTop = "8px";

      deleteBtn.addEventListener("click", async () => {
        if (!confirm("Are you sure you want to delete this product?")) return;

        const { error: delErr } = await supabase
          .from("products")
          .delete()
          .eq("id", product.id);

        if (delErr) {
          alert("Error deleting product: " + delErr.message);
        } else {
          loadProducts();
        }
      });

      card.appendChild(thumb);
      card.appendChild(titleLink);
      card.appendChild(price);
      card.appendChild(desc);
      card.appendChild(deleteBtn);

      productsList.appendChild(card);
    });
  }

  // --- SALES SUMMARY (simple) ---

  async function loadSalesSummary() {
    if (!currentUser) return;

    // Total orders and revenue
    const { data, error } = await supabase
      .from("orders")
      .select("amount_cents")
      .eq("seller_id", currentUser.id);

    if (error) {
      console.log("loadSalesSummary error", error);
      return;
    }

    const totalOrders = data ? data.length : 0;
    const totalRevenueCents = data
      ? data.reduce((sum, row) => sum + (row.amount_cents || 0), 0)
      : 0;

    totalOrdersEl.textContent = totalOrders;
    totalRevenueEl.textContent = (totalRevenueCents / 100).toFixed(2);

    // Recent orders
    const { data: recent, error: recErr } = await supabase
      .from("orders")
      .select("amount_cents, buyer_email, paid_at")
      .eq("seller_id", currentUser.id)
      .order("paid_at", { ascending: false })
      .limit(5);

    recentOrdersList.innerHTML = "";
    if (!recErr && recent && recent.length > 0) {
      recent.forEach(order => {
        const li = document.createElement("li");
        li.textContent = `${order.buyer_email || "Buyer"} - USD ${(order.amount_cents / 100).toFixed(2)}`;
        recentOrdersList.appendChild(li);
      });
    } else {
      const li = document.createElement("li");
      li.textContent = "No orders yet.";
      recentOrdersList.appendChild(li);
    }
  }

  // On page load
  checkSession();

  // Listen to auth state changes (e.g. after email confirmation redirect)
  supabase.auth.onAuthStateChange((_event, session) => {
    if (session && session.user) {
      currentUser = session.user;
      checkSession();
    }
  });
</script>

</body>
</html>
