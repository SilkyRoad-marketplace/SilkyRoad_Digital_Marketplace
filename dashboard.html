<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" href="/favicon.png">
<link rel="stylesheet" href="styles.css">
<title>Seller Dashboard – Silky Road</title>

<style>
body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:0;background:#f7f7f9;color:#222}
.container{max-width:1100px;margin:0 auto;padding:16px}

/* Banner (match index/login) */
.banner{
  position:relative;
  width:100%;
  margin:0;
  padding:0;
}
.banner img{
  width:100%;
  height:auto;
  display:block;
  max-height:420px;
  object-fit:cover;
}

/* Dashboard layout */
.dashboard-wrapper{
  display:flex;
  gap:20px;
  margin-top:24px;
}

/* Sidebar */
.sidebar{
  width:230px;
  background:#fff;
  border:1px solid #e6e6ea;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,0.05);
}
.sidebar h3{
  margin:0;
  padding:14px 16px;
  border-bottom:1px solid #eee;
  font-size:16px;
}
.sidebar button{
  width:100%;
  background:none;
  border:none;
  text-align:left;
  padding:10px 16px;
  border-bottom:1px solid #f0f0f0;
  cursor:pointer;
  font-size:14px;
}
.sidebar button.active{
  background:#2b6ef6;
  color:#fff;
}

/* Main content panel */
.dashboard-content{
  flex:1;
  background:#fff;
  border:1px solid #e6e6ea;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,0.05);
  padding:20px;
}

/* Top row */
.dashboard-header-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-top:20px;
}
.logout-btn{
  background:#f44336;
  color:#fff;
  border:none;
  padding:8px 14px;
  border-radius:6px;
  cursor:pointer;
}

/* Generic form elements */
.input-field, .textarea-field, select{
  width:100%;
  padding:8px;
  border:1px solid #ccc;
  border-radius:6px;
  margin-bottom:10px;
  font-size:14px;
  box-sizing:border-box;
}
.textarea-field{min-height:80px;resize:vertical;}

label{
  font-size:13px;
  font-weight:bold;
  display:block;
  margin-top:4px;
  margin-bottom:4px;
}

button.primary{
  background:#2b6ef6;
  color:#fff;
  border:none;
  padding:10px 16px;
  border-radius:6px;
  cursor:pointer;
}
button.danger{
  background:#f44336;
  color:#fff;
  border:none;
  padding:8px 14px;
  border-radius:6px;
  cursor:pointer;
}
button.small{
  font-size:13px;
  padding:6px 10px;
}
button.secondary{
  background:#555;
  color:#fff;
  border:none;
  padding:8px 14px;
  border-radius:6px;
  cursor:pointer;
}

/* Summary cards */
.summary-cards{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  margin-top:8px;
}
.summary-card{
  flex:1;
  min-width:160px;
  background:#fafafa;
  border:1px solid #e6e6ea;
  border-radius:8px;
  padding:12px;
}

/* Tables */
table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}
th,td{
  padding:8px;
  border-bottom:1px solid #eee;
}
th{
  background:#fafafa;
  text-align:left;
}

/* Upload grid */
.upload-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}
@media(max-width:800px){
  .dashboard-wrapper{flex-direction:column;}
  .sidebar{width:100%;}
  .upload-grid{grid-template-columns:1fr;}
}

/* Notices */
.notice{
  background:#fff8e1;
  border:1px solid #ffe0a3;
  padding:10px 12px;
  border-radius:6px;
  font-size:13px;
  margin-bottom:12px;
}
.error-text{color:#d00;font-size:13px;}
.success-text{color:#089600;font-size:13px;}
.text-muted{color:#777;font-size:13px;}
</style>
</head>
<body>

<!-- HEADER -->
<div id="header"></div>
<script>
fetch("header.html?v=1")
  .then(r=>r.text())
  .then(d=>document.getElementById("header").innerHTML=d)
  .catch(e=>console.error("Header load failed:",e));
</script>

<!-- BANNER -->
<div class="banner">
  <img src="banner.jpg" alt="Silky Road Banner">
</div>

<main class="container">
  <!-- Top welcome + logout -->
  <div class="dashboard-header-row">
    <div>
      <h1>Seller Dashboard</h1>
      <p id="welcomeLine" style="margin:4px 0;font-size:15px;">Loading your account…</p>
    </div>
    <button id="logoutBtn" class="logout-btn">Logout</button>
  </div>

  <div class="dashboard-wrapper">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <h3>Navigation</h3>
      <button class="nav-btn active" data-section="overview">Dashboard Home</button>
      <button class="nav-btn" data-section="products">My Products</button>
      <button class="nav-btn" data-section="upload">Upload Product</button>
      <button class="nav-btn" data-section="orders">My Orders</button>
      <button class="nav-btn" data-section="summary">Sales Summary</button>
      <button class="nav-btn" data-section="account">Account Settings</button>
    </aside>

    <!-- MAIN CONTENT -->
    <section class="dashboard-content">
      <!-- Overview -->
      <section id="section-overview">
        <h2>Overview</h2>
        <p>Use the sidebar to upload new products, manage your listings, and view your orders and sales performance.</p>
      </section>

      <!-- My Products -->
      <section id="section-products" style="display:none;">
        <h2>My Products</h2>
        <p class="text-muted">These are the products you currently sell on Silky Road.</p>
        <table>
          <thead>
            <tr>
              <th>Main Image</th>
              <th>Title</th>
              <th>Category</th>
              <th>Price (USD)</th>
              <th>Coupon</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="productsTbody"></tbody>
        </table>
        <p id="productsEmpty" class="text-muted"></p>
      </section>

      <!-- Upload Product -->
      <section id="section-upload" style="display:none;">
        <h2>Upload New Product</h2>
        <div id="uploadLockMessage" class="notice" style="display:none;">
          Please connect your PayPal email in <strong>Account Settings</strong> before uploading products.  
          This ensures buyers can pay you.
        </div>

        <form id="uploadForm">
          <div class="upload-grid">
            <div>
              <label for="productTitle">Title</label>
              <input id="productTitle" class="input-field" type="text" required>

              <label for="productPrice">Price (USD)</label>
              <input id="productPrice" class="input-field" type="number" step="0.01" min="0" required>

              <label for="productCategory">Category</label>
              <select id="productCategory" class="input-field">
                <option value="">Select category</option>
                <option value="Educational">Educational</option>
                <option value="Creative Assets">Creative Assets</option>
                <option value="Productivity">Productivity</option>
                <option value="Templates">Templates</option>
              </select>

              <label for="productSubcategory">Subcategory</label>
              <select id="productSubcategory" class="input-field">
                <option value="">Select subcategory</option>
              </select>

              <label for="externalLink">External Download Link (optional)</label>
              <input id="externalLink" class="input-field" type="text" placeholder="https://...">
            </div>

            <div>
              <label for="productDescription">Description</label>
              <textarea id="productDescription" class="textarea-field" placeholder="Describe your product."></textarea>

              <label for="productFile">Main Product File (max 10 MB)</label>
              <input id="productFile" class="input-field" type="file" accept=".zip,.pdf,.mp3,.mp4,.doc,.ppt,.xls,.txt,.epub">
              <p class="text-muted" style="margin-top:-6px;">Either upload a main file or provide an external link.</p>
            </div>
          </div>

          <h3 style="margin-top:16px;">Product Images</h3>
          <p class="text-muted">Main image is required. Image 2 and 3 are optional. JPG, PNG, GIF up to 5 MB each.</p>

          <div class="upload-grid">
            <div>
              <label for="image1">Main Product Image (required)</label>
              <input id="image1" class="input-field" type="file" accept="image/jpeg,image/png,image/gif">
            </div>
            <div>
              <label for="image2">Optional Image 2</label>
              <input id="image2" class="input-field" type="file" accept="image/jpeg,image/png,image/gif">
            </div>
            <div>
              <label for="image3">Optional Image 3</label>
              <input id="image3" class="input-field" type="file" accept="image/jpeg,image/png,image/gif">
            </div>
          </div>

          <h3 style="margin-top:16px;">Coupon (Optional)</h3>
          <p class="text-muted">This lets you define a coupon code and % discount for this product. Later we will apply this on the cart/checkout.</p>
          <div class="upload-grid">
            <div>
              <label for="couponCode">Coupon Code (optional)</label>
              <input id="couponCode" class="input-field" type="text" placeholder="e.g. SILKY10">
            </div>
            <div>
              <label for="couponPercent">Discount % (optional)</label>
              <input id="couponPercent" class="input-field" type="number" min="1" max="90" placeholder="e.g. 10">
            </div>
          </div>

          <button id="uploadBtn" class="primary" type="submit" style="margin-top:16px;">Upload Product</button>
          <p id="uploadMessage"></p>
        </form>
      </section>

      <!-- My Orders -->
      <section id="section-orders" style="display:none;">
        <h2>My Orders (as Seller)</h2>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Product</th>
              <th>Status</th>
              <th>Amount</th>
            </tr>
          </thead>
          <tbody id="ordersTbody"></tbody>
        </table>
        <p id="ordersEmpty" class="text-muted"></p>
      </section>

      <!-- Sales Summary -->
      <section id="section-summary" style="display:none;">
        <h2>Sales Summary</h2>
        <div class="summary-cards">
          <div class="summary-card">
            <div class="text-muted">Total Paid Orders</div>
            <div id="summaryOrders" style="font-size:20px;font-weight:bold;">0</div>
          </div>
          <div class="summary-card">
            <div class="text-muted">Total Revenue</div>
            <div id="summaryRevenue" style="font-size:20px;font-weight:bold;">USD 0.00</div>
          </div>
        </div>
        <p class="text-muted" style="margin-top:10px;">Based on orders where you are the seller and status is “paid”.</p>
      </section>

      <!-- Account Settings -->
      <section id="section-account" style="display:none;">
        <h2>Account Settings</h2>
        <p class="text-muted">Update your profile and PayPal payout email. You must set your PayPal email before uploading products.</p>

        <form id="accountForm">
          <div class="upload-grid">
            <div>
              <label for="accFirstName">First Name</label>
              <input id="accFirstName" class="input-field" type="text">

              <label for="accLastName">Last Name</label>
              <input id="accLastName" class="input-field" type="text">
            </div>
            <div>
              <label for="accDisplayName">Display Name</label>
              <input id="accDisplayName" class="input-field" type="text" placeholder="e.g. Andy Fisherman">

              <label for="accPaypalEmail">PayPal Email (required to receive payments)</label>
              <input id="accPaypalEmail" class="input-field" type="email" placeholder="your-paypal@example.com">
            </div>
          </div>

          <button class="primary" type="submit" style="margin-top:10px;">Save Settings</button>
          <p id="accountMessage"></p>
        </form>
        <!-- ❌ No Delete Account section anymore -->
      </section>
    </section>
  </div>
</main>

<!-- FOOTER -->
<footer class="footer"></footer>
<script>
fetch("footer.html?v=1")
  .then(r=>r.text())
  .then(d=>document.querySelector(".footer").innerHTML=d)
  .catch(e=>console.error("Footer load failed:",e));
</script>

<!-- DASHBOARD LOGIC -->
<script type="module">
import { supabase } from "/js/supabase-config.js";
// FORCE WORKING LOGOUT BUTTON (independent from all other code)
document.getElementById("logoutBtn").addEventListener("click", async () => {
  try {
    await supabase.auth.signOut();
    window.location.href = "login.html";
  } catch (err) {
    console.error("Logout error:", err);
  }
});

  
const welcomeLine = document.getElementById("welcomeLine");
const logoutBtn = document.getElementById("logoutBtn");
const navBtns = document.querySelectorAll(".nav-btn");
const sectionIds = ["overview","products","upload","orders","summary","account"];

/* everything below stays the same */

/* Category → Subcategory map */
const subcategoryMap = {
  "Educational": [
    "eBooks",
    "Online Courses",
    "Worksheets",
    "Tutorials",
    "Digital Workbooks"
  ],
  "Creative Assets": [
    "Stock Photos",
    "Videos",
    "Music / Audio Tracks",
    "Sound Effects",
    "Digital Art",
    "Fonts",
    "Brushes",
    "Lightroom Presets"
  ],
  "Productivity": [
    "Planners",
    "Journals",
    "Social Media Packs",
    "Business Templates",
    "Spreadsheets",
    "Notion Templates"
  ],
  "Templates": [
    "Canva Templates",
    "Digital Stickers",
    "Printable Games",
    "Craft Patterns",
    "Email Templates"
  ]
};

function populateSubcategories(selectedCategory, selectEl){
  selectEl.innerHTML = "";
  const defaultOpt = document.createElement("option");
  defaultOpt.value = "";
  defaultOpt.textContent = "Select subcategory";
  selectEl.appendChild(defaultOpt);

  const subs = subcategoryMap[selectedCategory] || [];
  subs.forEach(sub=>{
    const opt = document.createElement("option");
    opt.value = sub;
    opt.textContent = sub;
    selectEl.appendChild(opt);
  });
}

function formatMoneyFromCents(cents){
  if (typeof cents !== "number") return "USD 0.00";
  return "USD " + (cents / 100).toFixed(2);
}

/* Switch section */
function showSection(name){
  sectionIds.forEach(id=>{
    const el = document.getElementById("section-"+id);
    if (!el) return;
    el.style.display = (id === name) ? "block" : "none";
  });
  navBtns.forEach(btn=>{
    btn.classList.toggle("active", btn.dataset.section === name);
  });
}

/* Sidebar click handlers */
navBtns.forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const section = btn.dataset.section;
    showSection(section);
  });
});

/* MAIN: Check session */
supabase.auth.getSession().then(async ({ data })=>{
  if (!data.session){
    window.location.href = "login.html";
    return;
  }
  const user = data.session.user;

  const md = user.user_metadata || {};
  const namePieces = [];
  if (md.first_name) namePieces.push(md.first_name);
  if (md.last_name) namePieces.push(md.last_name);
  const display = (namePieces.join(" ") || md.display_name || user.email || "Seller");
  welcomeLine.textContent = "Welcome, " + display;

  setupLogout();
  setupAccount(user);
  setupUpload(user);
  loadMyProducts(user);
  loadOrdersAndSummary(user);
});

/* Logout */
function setupLogout(){
  logoutBtn.addEventListener("click", async ()=>{
    await supabase.auth.signOut();
    window.location.href = "login.html";
  });
}

/* Account Settings */
function setupAccount(user){
  const md = user.user_metadata || {};
  const accFirstName = document.getElementById("accFirstName");
  const accLastName  = document.getElementById("accLastName");
  const accDisplayName = document.getElementById("accDisplayName");
  const accPaypalEmail = document.getElementById("accPaypalEmail");
  const accountForm = document.getElementById("accountForm");
  const accountMessage = document.getElementById("accountMessage");

  accFirstName.value = md.first_name || "";
  accLastName.value  = md.last_name || "";
  accDisplayName.value = md.display_name || "";
  accPaypalEmail.value = md.paypal_email || "";

  accountForm.addEventListener("submit", async (e)=>{
    e.preventDefault();
    accountMessage.textContent = "";
    accountMessage.className = "";

    const firstName = accFirstName.value.trim();
    const lastName  = accLastName.value.trim();
    const displayName = accDisplayName.value.trim();
    const paypalEmail = accPaypalEmail.value.trim();

    if (!paypalEmail){
      accountMessage.textContent = "PayPal email is required to receive payments.";
      accountMessage.className = "error-text";
      return;
    }

    const { error } = await supabase.auth.updateUser({
      data:{
        first_name:firstName,
        last_name:lastName,
        display_name:displayName,
        paypal_email:paypalEmail
      }
    });

    if (error){
      accountMessage.textContent = error.message;
      accountMessage.className = "error-text";
      return;
    }

    accountMessage.textContent = "Settings updated.";
    accountMessage.className = "success-text";

    const namePieces = [];
    if (firstName) namePieces.push(firstName);
    if (lastName) namePieces.push(lastName);
    const display = (namePieces.join(" ") || displayName || user.email);
    welcomeLine.textContent = "Welcome, " + display;

    checkUploadLock(paypalEmail);
  });

  checkUploadLock(md.paypal_email || "");
}

/* Enforce PayPal requirement for uploading */
function checkUploadLock(paypalEmail){
  const lockNotice = document.getElementById("uploadLockMessage");
  const uploadBtn = document.getElementById("uploadBtn");
  const uploadForm = document.getElementById("uploadForm");

  if (!paypalEmail){
    if (lockNotice) lockNotice.style.display = "block";
    if (uploadBtn) uploadBtn.disabled = true;
    if (uploadForm) uploadForm.querySelectorAll("input,textarea,button,select").forEach(el=>{
      if (el.id !== "uploadBtn") el.disabled = true;
    });
  } else {
    if (lockNotice) lockNotice.style.display = "none";
    if (uploadBtn) uploadBtn.disabled = false;
    if (uploadForm) uploadForm.querySelectorAll("input,textarea,button,select").forEach(el=>{
      el.disabled = false;
    });
  }
}

/* Upload Product */
function setupUpload(user){
  const form = document.getElementById("uploadForm");
  const msg = document.getElementById("uploadMessage");

  // Category → subcategory dynamic behavior
  const catSelect = document.getElementById("productCategory");
  const subSelect = document.getElementById("productSubcategory");
  catSelect.addEventListener("change", ()=>{
    populateSubcategories(catSelect.value, subSelect);
  });

  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    msg.textContent = "";
    msg.className = "";

    const title = document.getElementById("productTitle").value.trim();
    const priceVal = parseFloat(document.getElementById("productPrice").value);
    const description = document.getElementById("productDescription").value.trim();
    const category = document.getElementById("productCategory").value.trim();
    const subcategory = document.getElementById("productSubcategory").value.trim();
    const externalLink = document.getElementById("externalLink").value.trim();

    const fileInput = document.getElementById("productFile");
    const mainImageFile = document.getElementById("image1").files[0] || null;
    const image2File = document.getElementById("image2").files[0] || null;
    const image3File = document.getElementById("image3").files[0] || null;

    const couponCode = document.getElementById("couponCode").value.trim();
    const couponPercentRaw = document.getElementById("couponPercent").value.trim();
    const couponPercent = couponPercentRaw ? parseInt(couponPercentRaw,10) : null;

    if (!title){
      msg.textContent = "Title is required.";
      msg.className = "error-text";
      return;
    }
    if (isNaN(priceVal) || priceVal < 0){
      msg.textContent = "Price must be a valid number.";
      msg.className = "error-text";
      return;
    }
    if (!category){
      msg.textContent = "Please choose a category.";
      msg.className = "error-text";
      return;
    }
    if (!subcategory){
      msg.textContent = "Please choose a subcategory.";
      msg.className = "error-text";
      return;
    }
    if (!mainImageFile){
      msg.textContent = "Main product image is required.";
      msg.className = "error-text";
      return;
    }

    const mainFile = fileInput.files[0] || null;
    const MAX_FILE_BYTES = 10 * 1024 * 1024; // 10MB for now
    const MAX_IMG_BYTES = 5 * 1024 * 1024;

    if (!mainFile && !externalLink){
      msg.textContent = "Upload a main file or provide an external download link.";
      msg.className = "error-text";
      return;
    }

    if (mainFile && mainFile.size > MAX_FILE_BYTES){
      msg.textContent = "Main file exceeds 10 MB.";
      msg.className = "error-text";
      return;
    }

    for (const f of [mainImageFile, image2File, image3File]){
      if (f && f.size > MAX_IMG_BYTES){
        msg.textContent = "One of the images exceeds 5 MB.";
        msg.className = "error-text";
        return;
      }
    }

    if (couponPercent !== null && (isNaN(couponPercent) || couponPercent < 1 || couponPercent > 90)){
      msg.textContent = "Coupon % must be between 1 and 90, or leave empty.";
      msg.className = "error-text";
      return;
    }

    msg.textContent = "Uploading product…";
    msg.className = "text-muted";

    let downloadUrl = externalLink || "";
    let mainImageUrl = null;
    let image2Url = null;
    let image3Url = null;

    try{
      async function uploadToBucket(path, file){
        const { error } = await supabase.storage.from("seller-uploads").upload(path, file);
        if (error) throw error;
        const { data } = supabase.storage.from("seller-uploads").getPublicUrl(path);
        return data.publicUrl;
      }

      const now = Date.now();

      if (mainFile){
        const filePath = `${user.id}/files/${now}_${mainFile.name}`;
        downloadUrl = await uploadToBucket(filePath, mainFile);
      }

      if (mainImageFile){
        const imgPath = `${user.id}/images/${now}_main_${mainImageFile.name}`;
        mainImageUrl = await uploadToBucket(imgPath, mainImageFile);
      }

      if (image2File){
        const imgPath2 = `${user.id}/images/${now}_img2_${image2File.name}`;
        image2Url = await uploadToBucket(imgPath2, image2File);
      }
      if (image3File){
        const imgPath3 = `${user.id}/images/${now}_img3_${image3File.name}`;
        image3Url = await uploadToBucket(imgPath3, image3File);
      }

      const { error:insertErr } = await supabase.from("products").insert({
        seller_id: user.id,
        title,
        description,
        price: priceVal,
        category,
        subcategory,
        main_image_url: mainImageUrl,
        image2_url: image2Url,
        image3_url: image3Url,
        download_url: downloadUrl,
        coupon_code: couponCode || null,
        coupon_percent: couponPercent
      });

      if (insertErr) throw insertErr;

      msg.textContent = "Product uploaded successfully.";
      msg.className = "success-text";

      form.reset();
      loadMyProducts(user);
    } catch(err){
      console.error("Upload error:", err);
      msg.textContent = "Error uploading product.";
      msg.className = "error-text";
    }
  });
}

/* Load My Products (with Edit + Delete using API) */
async function loadMyProducts(user){
  const tbody = document.getElementById("productsTbody");
  const empty = document.getElementById("productsEmpty");
  tbody.innerHTML = "";
  empty.textContent = "";

  const { data, error } = await supabase
    .from("products")
    .select("*")
    .eq("seller_id", user.id)
    .order("created_at",{ ascending:false });

  if (error){
    console.error(error);
    empty.textContent = "Error loading products.";
    return;
  }
  if (!data || data.length === 0){
    empty.textContent = "You haven't uploaded any products yet.";
    return;
  }

  data.forEach(p=>{
    const tr = document.createElement("tr");

    const mainImgCell = document.createElement("td");
    if (p.main_image_url){
      const img = document.createElement("img");
      img.src = p.main_image_url;
      img.alt = p.title || "Product";
      img.style.width = "60px";
      img.style.height = "60px";
      img.style.objectFit = "cover";
      img.style.borderRadius = "4px";
      img.style.cursor = "pointer";
      img.addEventListener("click", ()=>{
        window.location.href = "product.html?id=" + p.id;
      });
      mainImgCell.appendChild(img);
    } else {
      mainImgCell.textContent = "-";
    }

    const titleCell = document.createElement("td");
    const link = document.createElement("a");
    link.href = "product.html?id=" + p.id;
    link.textContent = p.title || "Untitled";
    link.style.textDecoration = "none";
    link.style.color = "#222";
    titleCell.appendChild(link);

    const catCell = document.createElement("td");
    catCell.textContent = p.category || "";

    const priceCell = document.createElement("td");
    const priceVal = (typeof p.price === "number") ? p.price.toFixed(2) : "0.00";
    priceCell.textContent = "USD " + priceVal;

    const couponCell = document.createElement("td");
    if (p.coupon_code && p.coupon_percent){
      couponCell.textContent = `${p.coupon_code} (${p.coupon_percent}% off)`;
    } else {
      couponCell.textContent = "-";
    }

    const actionsCell = document.createElement("td");

    // Edit button
    const editBtn = document.createElement("button");
    editBtn.textContent = "Edit";
    editBtn.className = "secondary small";
    editBtn.style.marginRight = "6px";
    editBtn.addEventListener("click", ()=>{
      window.location.href = "edit-product.html?id=" + p.id;
    });
    actionsCell.appendChild(editBtn);

    // Delete button (goes through /api/delete-product → deletes DB row + files)
    const delBtn = document.createElement("button");
    delBtn.textContent = "Delete";
    delBtn.className = "danger small";
    delBtn.addEventListener("click", async ()=>{
      const ok = window.confirm("Delete this product, including its files and images?");
      if (!ok) return;

      try{
        const res = await fetch("/api/delete-product", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            product_id: p.id,
            seller_id: user.id
          })
        });
        const result = await res.json();
        if (!res.ok || result.error){
          alert("Error deleting product: " + (result.error || res.statusText));
          console.error("Delete error:", result);
        } else {
          loadMyProducts(user);
        }
      } catch(e){
        console.error("Delete request failed:", e);
        alert("Failed to delete product (network error).");
      }
    });
    actionsCell.appendChild(delBtn);

    tr.appendChild(mainImgCell);
    tr.appendChild(titleCell);
    tr.appendChild(catCell);
    tr.appendChild(priceCell);
    tr.appendChild(couponCell);
    tr.appendChild(actionsCell);

    tbody.appendChild(tr);
  });
}

/* Orders + Summary */
async function loadOrdersAndSummary(user){
  const tbody = document.getElementById("ordersTbody");
  const empty = document.getElementById("ordersEmpty");
  const summaryOrders = document.getElementById("summaryOrders");
  const summaryRevenue = document.getElementById("summaryRevenue");

  tbody.innerHTML = "";
  empty.textContent = "";
  summaryOrders.textContent = "0";
  summaryRevenue.textContent = "USD 0.00";

  const { data, error } = await supabase
    .from("orders")
    .select("id,product_id,amount_cents,status,paid_at")
    .eq("seller_id", user.id)
    .order("paid_at",{ ascending:false });

  if (error){
    console.error(error);
    empty.textContent = "Error loading orders.";
    return;
  }
  if (!data || data.length === 0){
    empty.textContent = "No orders yet.";
    return;
  }

  const productIds = [...new Set(data.map(o=>o.product_id).filter(Boolean))];
  let productMap = {};
  if (productIds.length > 0){
    const { data:prodData, error:prodErr } = await supabase
      .from("products")
      .select("id,title")
      .in("id", productIds);
    if (!prodErr && prodData){
      prodData.forEach(p=>{ productMap[p.id] = p.title; });
    }
  }

  let totalOrders = 0;
  let totalCents = 0;

  data.forEach(o=>{
    const tr = document.createElement("tr");
    const dateStr = o.paid_at ? new Date(o.paid_at).toLocaleDateString() : "-";
    const title = productMap[o.product_id] || "(Unknown product)";
    const amountText = formatMoneyFromCents(o.amount_cents);

    const dateCell = document.createElement("td");
    dateCell.textContent = dateStr;

    const titleCell = document.createElement("td");
    titleCell.textContent = title;

    const statusCell = document.createElement("td");
    statusCell.textContent = o.status || "-";

    const amountCell = document.createElement("td");
    amountCell.textContent = amountText;

    tr.appendChild(dateCell);
    tr.appendChild(titleCell);
    tr.appendChild(statusCell);
    tr.appendChild(amountCell);

    tbody.appendChild(tr);

    if (o.status === "paid"){
      totalOrders += 1;
      if (typeof o.amount_cents === "number") totalCents += o.amount_cents;
    }
  });

  summaryOrders.textContent = String(totalOrders);
  summaryRevenue.textContent = formatMoneyFromCents(totalCents);
}
</script>

</body>
</html>
