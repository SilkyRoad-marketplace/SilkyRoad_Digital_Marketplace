<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" href="/favicon.png">
<link rel="stylesheet" href="styles.css">
<title>Seller Dashboard – Silky Road</title>

<style>
body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:0;background:#f7f7f9;color:#222}
.container{max-width:1100px;margin:0 auto;padding:16px}

/* Banner (match index/login) */
.banner{
  position:relative;
  width:100%;
  margin:0;
  padding:0;
}
.banner img{
  width:100%;
  height:auto;
  display:block;
  max-height:420px;
  object-fit:cover;
}

/* Dashboard layout */
.dashboard-wrapper{
  display:flex;
  gap:20px;
  margin-top:24px;
}

/* Sidebar */
.sidebar{
  width:230px;
  background:#fff;
  border:1px solid #e6e6ea;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,0.05);
}
.sidebar h3{
  margin:0;
  padding:14px 16px;
  border-bottom:1px solid #eee;
  font-size:16px;
}
.sidebar button{
  width:100%;
  background:none;
  border:none;
  text-align:left;
  padding:10px 16px;
  border-bottom:1px solid #f0f0f0;
  cursor:pointer;
  font-size:14px;
}
.sidebar button.active{
  background:#2b6ef6;
  color:#fff;
}

/* Main content panel */
.dashboard-content{
  flex:1;
  background:#fff;
  border:1px solid #e6e6ea;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,0.05);
  padding:20px;
}

/* Top row */
.dashboard-header-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-top:20px;
}
.logout-btn{
  background:#f44336;
  color:#fff;
  border:none;
  padding:8px 14px;
  border-radius:6px;
  cursor:pointer;
}

/* Generic form elements */
.input-field, .textarea-field, select{
  width:100%;
  padding:8px;
  border:1px solid #ccc;
  border-radius:6px;
  margin-bottom:10px;
  font-size:14px;
  box-sizing:border-box;
}
.textarea-field{min-height:80px;resize:vertical;}

label{
  font-size:13px;
  font-weight:bold;
  display:block;
  margin-top:4px;
  margin-bottom:4px;
}

button.primary{
  background:#2b6ef6;
  color:#fff;
  border:none;
  padding:10px 16px;
  border-radius:6px;
  cursor:pointer;
}
button.danger{
  background:#f44336;
  color:#fff;
  border:none;
  padding:8px 14px;
  border-radius:6px;
  cursor:pointer;
}
button.small{
  font-size:13px;
  padding:6px 10px;
}
button.secondary{
  background:#555;
  color:#fff;
  border:none;
  padding:8px 14px;
  border-radius:6px;
  cursor:pointer;
}

/* Summary cards */
.summary-cards{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  margin-top:8px;
}
.summary-card{
  flex:1;
  min-width:160px;
  background:#fafafa;
  border:1px solid #e6e6ea;
  border-radius:8px;
  padding:12px;
}

/* Tables */
table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}
th,td{
  padding:8px;
  border-bottom:1px solid #eee;
}
th{
  background:#fafafa;
  text-align:left;
}

/* Upload grid */
.upload-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}
@media(max-width:800px){
  .dashboard-wrapper{flex-direction:column;}
  .sidebar{width:100%;}
  .upload-grid{grid-template-columns:1fr;}
}

/* Notices */
.notice{
  background:#fff8e1;
  border:1px solid #ffe0a3;
  padding:10px 12px;
  border-radius:6px;
  font-size:13px;
  margin-bottom:12px;
}
.error-text{color:#d00;font-size:13px;}
.success-text{color:#089600;font-size:13px;}
.text-muted{color:#777;font-size:13px;}
</style>
</head>
<body>

<!-- HEADER -->
<div id="header"></div>
<script>
fetch("header.html?v=1")
  .then(r=>r.text())
  .then(d=>document.getElementById("header").innerHTML=d)
  .catch(e=>console.error("Header load failed:",e));
</script>

<!-- BANNER -->
<div class="banner">
  <img src="banner.jpg" alt="Silky Road Banner">
</div>

<main class="container">
  <!-- Top welcome + logout -->
  <div class="dashboard-header-row">
    <div>
      <h1>Seller Dashboard</h1>
      <p id="welcomeLine" style="margin:4px 0;font-size:15px;">Loading your account…</p>
    </div>
    <button id="logoutBtn" class="logout-btn">Logout</button>
  </div>

  <div class="dashboard-wrapper">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <h3>Navigation</h3>
      <button class="nav-btn active" data-section="overview">Dashboard Home</button>
      <button class="nav-btn" data-section="products">My Products</button>
      <button class="nav-btn" data-section="upload">Upload Product</button>
      <button class="nav-btn" data-section="orders">My Orders</button>
      <button class="nav-btn" data-section="summary">Sales Summary</button>
      <button class="nav-btn" data-section="account">Account Settings</button>
    </aside>

    <!-- MAIN CONTENT -->
    <section class="dashboard-content">
      <!-- Overview -->
      <section id="section-overview">
        <h2>Overview</h2>
        <p>Use the sidebar to upload new products, manage your listings, and view your orders and sales performance.</p>
      </section>

      <!-- My Products -->
      <section id="section-products" style="display:none;">
        <h2>My Products</h2>
        <p class="text-muted">These are the products you currently sell on Silky Road.</p>
        <table>
          <thead>
            <tr>
              <th>Main Image</th>
              <th>Title</th>
              <th>Category</th>
              <th>Price (USD)</th>
              <th>Coupon</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="productsTbody"></tbody>
        </table>
        <p id="productsEmpty" class="text-muted"></p>
      </section>

      <!-- Upload Product -->
      <section id="section-upload" style="display:none;">
        <h2>Upload New Product</h2>
        <div id="uploadLockMessage" class="notice" style="display:none;">
          Please connect your PayPal email in <strong>Account Settings</strong> before uploading products.  
          This ensures buyers can pay you.
        </div>

        <form id="uploadForm">
          <div class="upload-grid">
            <div>
              <label for="productTitle">Title</label>
              <input id="productTitle" class="input-field" type="text" required>

              <label for="productPrice">Price (USD)</label>
              <input id="productPrice" class="input-field" type="number" step="0.01" min="0" required>

              <label for="productCategory">Category</label>
              <select id="productCategory" class="input-field">
                <option value="">Select category</option>
                <option value="Educational">Educational</option>
                <option value="Creative Assets">Creative Assets</option>
                <option value="Productivity">Productivity</option>
                <option value="Templates">Templates</option>
              </select>

              <label for="productSubcategory">Subcategory</label>
              <select id="productSubcategory" class="input-field">
                <option value="">Select subcategory</option>
              </select>

              <label for="externalLink">External Download Link (optional)</label>
              <input id="externalLink" class="input-field" type="text" placeholder="https://...">
            </div>

            <div>
              <label for="productDescription">Description</label>
              <textarea id="productDescription" class="textarea-field" placeholder="Describe your product."></textarea>

              <label for="productFile">Main Product File (max 10 MB)</label>
              <input id="productFile" class="input-field" type="file" accept=".zip,.pdf,.mp3,.mp4,.doc,.ppt,.xls,.txt,.epub">
              <p class="text-muted" style="margin-top:-6px;">Either upload a main file or provide an external link.</p>
            </div>
          </div>

          <h3 style="margin-top:16px;">Product Images</h3>
          <p class="text-muted">Main image is required. Image 2 and 3 are optional. JPG, PNG, GIF up to 5 MB each.</p>

          <div class="upload-grid">
            <div>
              <label for="image1">Main Product Image (required)</label>
              <input id="image1" class="input-field" type="file" accept="image/jpeg,image/png,image/gif">
            </div>
            <div>
              <label for="image2">Optional Image 2</label>
              <input id="image2" class="input-field" type="file" accept="image/jpeg,image/png,image/gif">
            </div>
            <div>
              <label for="image3">Optional Image 3</label>
              <input id="image3" class="input-field" type="file" accept="image/jpeg,image/png,image/gif">
            </div>
          </div>

          <h3 style="margin-top:16px;">Coupon (Optional)</h3>
          <p class="text-muted">This lets you define a coupon code and % discount for this product. Later we will apply this on the cart/checkout.</p>
          <div class="upload-grid">
            <div>
              <label for="couponCode">Coupon Code (optional)</label>
              <input id="couponCode" class="input-field" type="text" placeholder="e.g. SILKY10">
            </div>
            <div>
              <label for="couponPercent">Discount % (optional)</label>
              <input id="couponPercent" class="input-field" type="number" min="1" max="90" placeholder="e.g. 10">
            </div>
          </div>

          <button id="uploadBtn" class="primary" type="submit" style="margin-top:16px;">Upload Product</button>
          <p id="uploadMessage"></p>
        </form>
      </section>

      <!-- My Orders -->
      <section id="section-orders" style="display:none;">
        <h2>My Orders (as Seller)</h2>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Product</th>
              <th>Status</th>
              <th>Amount</th>
            </tr>
          </thead>
          <tbody id="ordersTbody"></tbody>
        </table>
        <p id="ordersEmpty" class="text-muted"></p>
      </section>

      <!-- Sales Summary -->
      <section id="section-summary" style="display:none;">
        <h2>Sales Summary</h2>
        <div class="summary-cards">
          <div class="summary-card">
            <div class="text-muted">Total Paid Orders</div>
            <div id="summaryOrders" style="font-size:20px;font-weight:bold;">0</div>
          </div>
          <div class="summary-card">
            <div class="text-muted">Total Revenue</div>
            <div id="summaryRevenue" style="font-size:20px;font-weight:bold;">USD 0.00</div>
          </div>
        </div>
        <p class="text-muted" style="margin-top:10px;">Based on orders where you are the seller and status is “paid”.</p>
      </section>

      <!-- Account Settings -->
      <section id="section-account" style="display:none;">
        <h2>Account Settings</h2>
        <p class="text-muted">Update your profile and PayPal payout email. You must set your PayPal email before uploading products.</p>

        <form id="accountForm">
          <div class="upload-grid">
            <div>
              <label for="accFirstName">First Name</label>
              <input id="accFirstName" class="input-field" type="text">

              <label for="accLastName">Last Name</label>
              <input id="accLastName" class="input-field" type="text">
            </div>
            <div>
              <label for="accDisplayName">Display Name</label>
              <input id="accDisplayName" class="input-field" type="text" placeholder="e.g. Andy Fisherman">

              <label for="accPaypalEmail">PayPal Email (required to receive payments)</label>
              <input id="accPaypalEmail" class="input-field" type="email" placeholder="your-paypal@example.com">
            </div>
          </div>

          <button class="primary" type="submit" style="margin-top:10px;">Save Settings</button>
          <p id="accountMessage"></p>
        </form>
        <!-- ❌ No Delete Account section anymore -->
      </section>
    </section>
  </div>
</main>

<!-- FOOTER -->
<footer class="footer"></footer>
<script>
fetch("footer.html?v=1")
  .then(r=>r.text())
  .then(d=>document.querySelector(".footer").innerHTML=d)
  .catch(e=>console.error("Footer load failed:",e));
</script>

<!-- DASHBOARD LOGIC -->
<script type="module">
import { supabase } from "/js/supabase-config.js";

const welcomeLine = document.getElementById("welcomeLine");
const logoutBtn   = document.getElementById("logoutBtn");
const navBtns     = document.querySelectorAll(".nav-btn");
const sectionIds  = ["overview","products","upload","orders","summary","account"];

/* ------------------ FIXED LOGOUT BUTTON (WORKS EVERYWHERE) ------------------ */
logoutBtn.addEventListener("click", async () => {
  try {
    await supabase.auth.signOut();
    window.location.href = "login.html";
  } catch (err) {
    console.error("Logout error:", err);
    alert("Logout failed. Please retry.");
  }
});

/* --------------------------- CATEGORY MAP --------------------------- */
const subcategoryMap = {
  "Educational": ["eBooks","Online Courses","Worksheets","Tutorials","Digital Workbooks"],
  "Creative Assets": ["Stock Photos","Videos","Music / Audio Tracks","Sound Effects","Digital Art","Fonts","Brushes","Lightroom Presets"],
  "Productivity": ["Planners","Journals","Social Media Packs","Business Templates","Spreadsheets","Notion Templates"],
  "Templates": ["Canva Templates","Digital Stickers","Printable Games","Craft Patterns","Email Templates"]
};

function populateSubcategories(selected, selectEl){
  selectEl.innerHTML = "";
  const def = document.createElement("option");
  def.value = "";
  def.textContent = "Select subcategory";
  selectEl.appendChild(def);
  (subcategoryMap[selected] || []).forEach(sc=>{
    const opt = document.createElement("option");
    opt.value = sc;
    opt.textContent = sc;
    selectEl.appendChild(opt);
  });
}

/* --------------------------- SECTION SWITCHING --------------------------- */
function showSection(name){
  sectionIds.forEach(id=>{
    document.getElementById("section-"+id).style.display = (id===name?"block":"none");
  });
  navBtns.forEach(btn=>{
    btn.classList.toggle("active", btn.dataset.section===name);
  });
}

navBtns.forEach(btn=>{
  btn.addEventListener("click", ()=>{
    showSection(btn.dataset.section);
  });
});

/* --------------------------- SESSION CHECK --------------------------- */
supabase.auth.getSession().then(async ({ data })=>{
  if (!data.session){
    window.location.href = "login.html";
    return;
  }

  const user = data.session.user;
  setupWelcome(user);
  setupAccount(user);
  setupUpload(user);
  loadMyProducts(user);
  loadOrdersAndSummary(user);
});

/* --------------------------- WELCOME NAME --------------------------- */
function setupWelcome(user){
  const md = user.user_metadata || {};
  const name = [
    md.first_name || "",
    md.last_name  || ""
  ].join(" ").trim() || md.display_name || user.email;

  welcomeLine.textContent = "Welcome, " + name;
}

/* --------------------------- ACCOUNT SETTINGS --------------------------- */
function setupAccount(user){
  const md = user.user_metadata || {};

  const f = id => document.getElementById(id);

  f("accFirstName").value   = md.first_name   || "";
  f("accLastName").value    = md.last_name    || "";
  f("accDisplayName").value = md.display_name || "";
  f("accPaypalEmail").value = md.paypal_email || "";

  const accountForm = f("accountForm");
  const msg = f("accountMessage");

  accountForm.addEventListener("submit", async(e)=>{
    e.preventDefault();
    msg.textContent = "";

    const pEmail = f("accPaypalEmail").value.trim();
    if (!pEmail){
      msg.textContent = "PayPal email is required.";
      msg.className = "error-text";
      return;
    }

    const { error } = await supabase.auth.updateUser({
      data:{
        first_name: f("accFirstName").value.trim(),
        last_name: f("accLastName").value.trim(),
        display_name: f("accDisplayName").value.trim(),
        paypal_email: pEmail
      }
    });

    if (error){
      msg.textContent = error.message;
      msg.className = "error-text";
      return;
    }

    msg.textContent = "Settings updated.";
    msg.className = "success-text";
  });
}

/* --------------------------- UPLOAD PRODUCT --------------------------- */
function setupUpload(user){
  const form = document.getElementById("uploadForm");
  const msg  = document.getElementById("uploadMessage");

  const catSelect = document.getElementById("productCategory");
  const subSelect = document.getElementById("productSubcategory");

  catSelect.addEventListener("change", ()=>{
    populateSubcategories(catSelect.value, subSelect);
  });

  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    msg.textContent = "";
    msg.className = "";

    const mainImageFile = document.getElementById("image1").files[0];
    if (!mainImageFile){
      msg.textContent = "Main product image is required.";
      msg.className = "error-text";
      return;
    }

    msg.textContent = "Uploading…";
    msg.className = "text-muted";

    try {

      async function uploadToBucket(path, file){
        const { error } = await supabase.storage.from("seller-uploads").upload(path, file);
        if (error) throw error;
        const { data } = supabase.storage.from("seller-uploads").getPublicUrl(path);
        return data.publicUrl;
      }

      const now = Date.now();
      const imgPath = `${user.id}/images/${now}_${mainImageFile.name}`;
      const mainImageUrl = await uploadToBucket(imgPath, mainImageFile);

      // Insert product
      const { error } = await supabase.from("products").insert({
        seller_id: user.id,
        title: document.getElementById("productTitle").value.trim(),
        description: document.getElementById("productDescription").value.trim(),
        price: parseFloat(document.getElementById("productPrice").value),
        category: catSelect.value,
        subcategory: subSelect.value,
        main_image_url: mainImageUrl
      });

      if (error) throw error;

      msg.textContent = "Product uploaded.";
      msg.className = "success-text";
      form.reset();

    } catch(err){
      console.error("UPLOAD ERROR:", err);
      msg.textContent = "Upload failed: " + (err.message || JSON.stringify(err));
      msg.className = "error-text";
    }

  });
}

/* --------------------------- LOAD PRODUCTS --------------------------- */
async function loadMyProducts(user){
  const tbody = document.getElementById("productsTbody");
  const empty = document.getElementById("productsEmpty");
  tbody.innerHTML = "";
  empty.textContent = "";

  const { data, error } = await supabase
    .from("products")
    .select("*")
    .eq("seller_id", user.id);

  if (error){
    empty.textContent = "Error loading products.";
    return;
  }
  if (!data.length){
    empty.textContent = "You haven't uploaded any products.";
    return;
  }

  data.forEach(p=>{
    const tr = document.createElement("tr");

    const tdImg = document.createElement("td");
    if (p.main_image_url){
      const img = document.createElement("img");
      img.src = p.main_image_url;
      img.style.width = "50px";
      img.style.height = "50px";
      img.style.objectFit = "cover";
      tdImg.appendChild(img);
    } else tdImg.textContent = "-";

    const tdTitle = document.createElement("td");
    tdTitle.textContent = p.title;

    const tdCat = document.createElement("td");
    tdCat.textContent = p.category;

    const tdPrice = document.createElement("td");
    tdPrice.textContent = "USD " + p.price.toFixed(2);

    tr.appendChild(tdImg);
    tr.appendChild(tdTitle);
    tr.appendChild(tdCat);
    tr.appendChild(tdPrice);

    tbody.appendChild(tr);
  });
}

/* --------------------------- LOAD ORDERS + SUMMARY --------------------------- */
async function loadOrdersAndSummary(user){
  const tbody = document.getElementById("ordersTbody");
  const empty = document.getElementById("ordersEmpty");
  tbody.innerHTML = "";
  empty.textContent = "";

  const summaryOrders  = document.getElementById("summaryOrders");
  const summaryRevenue = document.getElementById("summaryRevenue");

  const { data, error } = await supabase
    .from("orders")
    .select("*")
    .eq("seller_id", user.id);

  if (error){
    empty.textContent = "Error loading orders.";
    return;
  }
  if (!data.length){
    empty.textContent = "No orders.";
    return;
  }

  let count = 0;
  let total = 0;

  data.forEach(o=>{
    const tr = document.createElement("tr");

    const td1 = document.createElement("td");
    td1.textContent = o.paid_at ? new Date(o.paid_at).toLocaleDateString() : "-";

    const td2 = document.createElement("td");
    td2.textContent = o.product_id || "-";

    const td3 = document.createElement("td");
    td3.textContent = o.status || "-";

    const td4 = document.createElement("td");
    td4.textContent = "USD " + (o.amount_cents/100).toFixed(2);

    tr.appendChild(td1);
    tr.appendChild(td2);
    tr.appendChild(td3);
    tr.appendChild(td4);

    tbody.appendChild(tr);

    if (o.status === "paid"){
      count++;
      total += o.amount_cents;
    }
  });

  summaryOrders.textContent = count;
  summaryRevenue.textContent = "USD " + (total/100).toFixed(2);
}
</script>


</body>
</html>
